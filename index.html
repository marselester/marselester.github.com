<!DOCTYPE html>
<head>
    <meta charset="utf-8" />
    <!-- Set the viewport width to device width for mobile -->
    <meta name="viewport" content="width=device-width" />

    <title>marselester's blog</title>

    <link rel="stylesheet" href="https://marselester.com/theme/css/normalize.css" />
    <link rel="stylesheet" href="https://marselester.com/theme/css/foundation.min.css" />
    <link rel="stylesheet" href="https://marselester.com/theme/css/style.css" />
    <link rel="stylesheet" href="https://marselester.com/theme/css/pygments.css" />	
    <script src="https://marselester.com/theme/js/custom.modernizr.js"></script>

    <!-- So Firefox can bookmark->"abo this site" -->
        <link href="feeds/all.atom.xml" rel="alternate" title="marselester's blog" type="application/atom+xml">

</head>

<body>

<!-- Nav Bar -->
<nav>
<div class="top-bar">
<div class="row">
    <div class="large-9 large-centered columns">
	    <h1><a href="https://marselester.com">marselester's blog</a></h1>
    </div>
</div>
</div>

<!-- Show menu items and pages -->
<div class="row">
<div class="large-9 columns">
    <ul class="button-group navigation">

            <li><a href="https://marselester.com/pages/about.html" class="button secondary small">About</a></li>
    </ul>
</div>
</div>
</nav>
<!-- End Nav -->


<!-- Main Page Content and Sidebar -->
<div class="row">

    <!-- Main Blog Content -->
    <div class="large-9 columns">
        
        

            <article>
                <a href="https://marselester.com/continuous-profiling-in-go.html"><h3 class="article-title">Continuous profiling in Go</h3></a>
<h6 class="subheader" title="2022-04-22T00:00:00+07:00">Fri 22 April 2022
</h6>


<p>In this post I explore possibilities of continuous profiling of Go programs
using Parca and also peek under the hood of its BPF agent.
You can find the results of my experiments in
<a href="https://github.com/marselester/diy-parca-agent">github.com/marselester/diy-parca-agent</a>.</p>
<h2>Ad hoc profiling</h2>
<p>I was looking for a way to profile Go programs running in Kubernetes
to see where a program spends its CPU time (which functions consume most CPU)
or where memory allocations happen.
Allocations in a frequently called function could cause GC pressure
which in turn could cause latency spikes in HTTP requests.</p>
<p>Latency of the Bookstore service is taken seriously,
so its API server already had <code>import _ "net/http/pprof"</code> to enable profiling with <code>go tool pprof</code> program.
In order to get access to the HTTP server running in the pod
a port forwarder could be used.</p>
<div class="highlight"><pre><span></span><code><span class="go">﹩ kubectl get pods -A | grep bookstore</span>
<span class="go">default                  bookstore-574897d6-e18e</span>
<span class="go">﹩ kubectl port-forward -n default bookstore-574897d6-e18e 6060 &amp;</span>
<span class="go">Forwarding from 127.0.0.1:6060 -&gt; 6060</span>
<span class="go">Forwarding from [::1]:6060 -&gt; 6060</span>
<span class="go">﹩ fg 1</span>
</code></pre></div>

<p>The following URLs under <code>/debug/pprof/</code> provide profiling data.</p>
<div class="highlight"><pre><span></span><code><span class="go">＃ 30-second CPU profile.</span>
<span class="go">﹩ curl http://0.0.0.0:6060/debug/pprof/profile --output ./cpu.pprof</span>
<span class="go">＃ Heap allocations profile since the process started</span>
<span class="go">＃ including garbage-collected bytes (useful when optimising code).</span>
<span class="go">﹩ curl http://0.0.0.0:6060/debug/pprof/allocs --output ./heap-all.pprof</span>
<span class="go">＃ Heap allocations of live objects (useful when looking for memory leaks).</span>
<span class="go">﹩ curl http://0.0.0.0:6060/debug/pprof/heap --output ./heap-live.pprof</span>
</code></pre></div>

<p>In order to inspect the heap profile <code>heap-all.pprof</code>
I would need to compile the API <code>server</code> program and fix the search path for source files:</p>
<ul>
<li><code>source_path</code> is an absolute path to your source code (the Bookstore's git repository),
  e.g., on Mac it could be <code>/Users/bob/code/bookstore/</code>.</li>
<li><code>trim_path</code> is a path the profile expects the code to be at, e.g.,
  <code>/opt/bookstore/</code> because the binary was compiled in Docker by CI/CD</li>
</ul>
<div class="highlight"><pre><span></span><code><span class="go">﹩ GOOS=linux go build ./cmd/server/</span>
<span class="go">﹩ go tool pprof -source_path=&quot;$(pwd)&quot; -trim_path=/opt/bookstore/ ./server ./heap-all.pprof</span>
<span class="go">﹪ web</span>
<span class="go">﹪ top10 -cum</span>
</code></pre></div>

<p>The <code>web</code> command opens an allocation graph of function calls.
The <code>top10 -cum</code> command shows top ten functions by allocations in that function
or a function it called (cumulative) down the stack:</p>
<ul>
<li><code>flat</code> is a memory allocated by that function and is held by it</li>
<li><code>cum</code> is a memory allocated by that function or a function it called down the stack.
  When <code>flat</code> and <code>cum</code> numbers match,
  this might indicate the allocated memory is retained.</li>
</ul>
<h2>Continuous profiling</h2>
<p>I could be lucky and discover some obvious problem,
though most likely by the time the profiles are collected it is already too late
because a Kubernetes pod in question is already gone.</p>
<p>A continuous profiler could have collected the data
when a problem was occuring on production,
so I was curious to see what open source tooling is available.
Here is what I found so far:</p>
<ul>
<li><a href="https://www.parca.dev/">Parca</a></li>
<li><a href="https://pyroscope.io/">Pyroscope</a></li>
<li><a href="https://github.com/profefe/profefe">profefe</a></li>
</ul>
<p>All of them are capable, moreover Parca and Pyroscope have BPF agents.
I experimented with Parca more because I stumbled on it earlier.
So here is how Parca Server configuration looked like
when I set it up to collect profiles every minute from the Bookstore service.</p>
<div class="highlight"><pre><span></span><code><span class="nt">debug_info</span><span class="p">:</span>
  <span class="nt">bucket</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="s">&quot;FILESYSTEM&quot;</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">directory</span><span class="p">:</span> <span class="s">&quot;./tmp&quot;</span>
  <span class="nt">cache</span><span class="p">:</span>
    <span class="nt">type</span><span class="p">:</span> <span class="s">&quot;FILESYSTEM&quot;</span>
    <span class="nt">config</span><span class="p">:</span>
      <span class="nt">directory</span><span class="p">:</span> <span class="s">&quot;./tmp&quot;</span>

<span class="nt">scrape_configs</span><span class="p">:</span>
  <span class="p p-Indicator">-</span> <span class="nt">job_name</span><span class="p">:</span> <span class="s">&quot;bookstore&quot;</span>
    <span class="nt">scrape_interval</span><span class="p">:</span> <span class="s">&quot;1m&quot;</span>
    <span class="nt">scrape_timeout</span><span class="p">:</span> <span class="s">&quot;15s&quot;</span>
    <span class="nt">static_configs</span><span class="p">:</span>
      <span class="p p-Indicator">-</span> <span class="nt">targets</span><span class="p">:</span> <span class="p p-Indicator">[</span> <span class="s">&#39;bookstore.default:6060&#39;</span> <span class="p p-Indicator">]</span>
</code></pre></div>

<p>Note, the config above is part of
<a href="https://github.com/parca-dev/parca/releases/download/v0.10.0/kubernetes-manifest.yaml">kubernetes-manifest.yaml</a>.
Check out <a href="https://www.parca.dev/docs/kubernetes">Parca tutorial</a> to learn more.</p>
<h2>BPF profiling agent</h2>
<p>The cool things about BPF profiling agents are that they incur low overhead,
can capture user/kernel-space stack traces, and don't need much configuration
because they discover containers on the Kubernetes node where an agent is running.</p>
<p>A quick summary about BPF.
In the kernel, a BPF program is executed on each event.
The event types could be kprobes, uprobes, tracepoints, sockets, perf_events.
It can use BPF helpers to fetch kernel state, and BPF maps for storage.
In user space BPF maps or a perf buffer are periodically read and some output (summary) is shown to a user.</p>
<p>I was curious how Parca Agent was implemented.
According to its <a href="https://github.com/parca-dev/parca-agent/blob/main/docs/design.md">design doc</a>
it attaches the BPF program to a Linux cgroup using
<a href="https://man7.org/linux/man-pages/man2/perf_event_open.2.html">perf_event_open()</a> system call.
The call creates a file descriptor that allows measuring performance information.
It instructs the kernel to call the BPF program 100 times per second.</p>
<p>Here I annotated
<a href="https://github.com/parca-dev/parca-agent/blob/1e935f4d5f7b4484f6cf3d4ee26340f3718ff37d/pkg/profiler/profiler.go#L270">github.com/parca-dev/parca-agent/pkg/profiler/profiler.go</a> code around the syscall.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// To discover cgroups to profile in Kubernetes,</span>
<span class="c1">// Parca Agent first discovers all pods running on the node it is on,</span>
<span class="c1">// then discovers the primary PID of the cgroup using Kubernetes CRI (container runtime interface).</span>
<span class="c1">// For profiling purposes a perf_event cgroup is required, which is read from /proc/PID/cgroup.</span>
<span class="nx">cgroup</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">os</span><span class="p">.</span><span class="nx">Open</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
<span class="c1">// The pid and cpu arguments allow specifying which process and CPU to monitor.</span>
<span class="nx">pid</span> <span class="o">:=</span> <span class="nb">int</span><span class="p">(</span><span class="nx">cgroup</span><span class="p">.</span><span class="nx">Fd</span><span class="p">())</span>

<span class="k">for</span> <span class="nx">cpu</span> <span class="o">:=</span> <span class="mi">0</span><span class="p">;</span> <span class="nx">cpu</span> <span class="p">&lt;</span> <span class="nx">runtime</span><span class="p">.</span><span class="nx">NumCPU</span><span class="p">();</span> <span class="nx">cpu</span><span class="o">++</span> <span class="p">{</span>
    <span class="nx">fd</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PerfEventOpen</span><span class="p">(</span>
        <span class="o">&amp;</span><span class="nx">unix</span><span class="p">.</span><span class="nx">PerfEventAttr</span><span class="p">{</span>
            <span class="c1">// PERF_TYPE_SOFTWARE event type indicates that</span>
            <span class="c1">// we are measuring software events provided by the kernel.</span>
            <span class="nx">Type</span><span class="p">:</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PERF_TYPE_SOFTWARE</span><span class="p">,</span>
            <span class="c1">// Config is a Type-specific configuration.</span>
            <span class="c1">// PERF_COUNT_SW_CPU_CLOCK reports the CPU clock, a high-resolution per-CPU timer.</span>
            <span class="nx">Config</span><span class="p">:</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PERF_COUNT_SW_CPU_CLOCK</span><span class="p">,</span>
            <span class="c1">// Size of attribute structure for forward/backward compatibility.</span>
            <span class="nx">Size</span><span class="p">:</span> <span class="nb">uint32</span><span class="p">(</span><span class="nx">unsafe</span><span class="p">.</span><span class="nx">Sizeof</span><span class="p">(</span><span class="nx">unix</span><span class="p">.</span><span class="nx">PerfEventAttr</span><span class="p">{})),</span>
            <span class="c1">// Sample could mean sampling period (expressed as the number of occurrences of an event)</span>
            <span class="c1">// or frequency (the average rate of samples per second).</span>
            <span class="c1">// See https://perf.wiki.kernel.org/index.php/Tutorial#Period_and_rate.</span>
            <span class="c1">// In order to use frequency PerfBitFreq flag is set below.</span>
            <span class="c1">// The kernel will adjust the sampling period to try and achieve the desired rate.</span>
            <span class="nx">Sample</span><span class="p">:</span> <span class="mi">100</span><span class="p">,</span>
            <span class="nx">Bits</span><span class="p">:</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PerfBitDisabled</span> <span class="p">|</span> <span class="nx">unix</span><span class="p">.</span><span class="nx">PerfBitFreq</span><span class="p">,</span>
        <span class="p">},</span>
        <span class="nx">pid</span><span class="p">,</span>
        <span class="nx">cpu</span><span class="p">,</span>
        <span class="c1">// This argument allows event groups to be created.</span>
        <span class="c1">// A single event on its own is created with groupFd = -1</span>
        <span class="c1">// and is considered to be a group with only 1 member.</span>
        <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="c1">// PERF_FLAG_PID_CGROUP flag activates per-container system-wide monitoring.</span>
        <span class="c1">// In this mode, the event is measured only if the thread running on the monitored CPU</span>
        <span class="c1">// belongs to the designated container (cgroup).</span>
        <span class="nx">unix</span><span class="p">.</span><span class="nx">PERF_FLAG_PID_CGROUP</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3>BPF C code</h3>
<p>From looking at BPF C code
<a href="https://github.com/parca-dev/parca-agent/blob/31253527651ebebb74c6200eb68fe9251479ed6b/parca-agent.bpf.c">parca-agent.bpf.c</a>
we can see the BPF program <code>do_sample</code>.
As mentioned above it's executed 100 times per second.
Each time it captures stack traces of the thread that is currently running on CPU.</p>
<div class="highlight"><pre><span></span><code><span class="n">SEC</span><span class="p">(</span><span class="s">&quot;perf_event&quot;</span><span class="p">)</span>
<span class="kt">int</span> <span class="n">do_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">bpf_perf_event_data</span> <span class="o">*</span><span class="n">ctx</span><span class="p">)</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</code></pre></div>

<p><code>SEC("perf_event")</code> denotes <code>BPF_PROG_TYPE_PERF_EVENT</code> BPF program type
which specifies the type of events that the BPF program attaches to (perf_events),
and the arguments for the events.</p>
<div class="highlight"><pre><span></span><code><span class="n">u64</span> <span class="n">id</span> <span class="o">=</span> <span class="n">bpf_get_current_pid_tgid</span><span class="p">();</span>
<span class="n">u32</span> <span class="n">tgid</span> <span class="o">=</span> <span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="n">u32</span> <span class="n">pid</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
</code></pre></div>

<p><a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/bpf.h#L1777">bpf_get_current_pid_tgid()</a>
BPF helper returns an unsigned 64-bit integer containing
the current TGID (what user space calls the PID) in the upper bits and
the current PID (what user space calls the kernel thread ID) in the lower bits.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Max amount of different stack trace addresses to buffer in the map.</span>
<span class="cp">#define MAX_STACK_ADDRESSES 1024</span>
<span class="c1">// Max depth of each stack trace to track.</span>
<span class="cp">#define MAX_STACK_DEPTH 127</span>
<span class="c1">// Stack trace value is 1 big byte array of the stack addresses.</span>
<span class="k">typedef</span> <span class="n">__u64</span> <span class="n">stack_trace_type</span><span class="p">[</span><span class="n">MAX_STACK_DEPTH</span><span class="p">];</span>

<span class="c1">// The stack_traces map holds an array of memory addresses,</span>
<span class="c1">// e.g., stack_traces[1253] = [0xdeadbeef, 0x123abcde]</span>
<span class="c1">// where 1253 is a stack ID.</span>
<span class="k">struct</span> <span class="p">{</span>
    <span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">BPF_MAP_TYPE_STACK_TRACE</span><span class="p">);</span>
    <span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span> <span class="n">MAX_STACK_ADDRESSES</span><span class="p">);</span>
    <span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">u32</span><span class="p">);</span>
    <span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">stack_trace_type</span><span class="p">);</span>
<span class="p">}</span> <span class="n">stack_traces</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">stack_count_key_t</span> <span class="p">{</span>
    <span class="n">u32</span> <span class="n">pid</span><span class="p">;</span>
    <span class="n">int32</span> <span class="n">user_stack_id</span><span class="p">;</span>
    <span class="n">int32</span> <span class="n">kernel_stack_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="c1">// The counts map keeps track of how many times a stack trace has been seen,</span>
<span class="c1">// e.g., counts[{10342, 1253, 0234}] = 45 times.</span>
<span class="k">struct</span> <span class="p">{</span>
    <span class="n">__uint</span><span class="p">(</span><span class="n">type</span><span class="p">,</span> <span class="n">BPF_MAP_TYPE_HASH</span><span class="p">);</span>
    <span class="n">__uint</span><span class="p">(</span><span class="n">max_entries</span><span class="p">,</span> <span class="mi">10240</span><span class="p">);</span>
    <span class="n">__type</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="k">struct</span> <span class="n">stack_count_key_t</span><span class="p">);</span>
    <span class="n">__type</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">u64</span><span class="p">);</span>
<span class="p">}</span> <span class="n">counts</span> <span class="n">SEC</span><span class="p">(</span><span class="s">&quot;.maps&quot;</span><span class="p">);</span>
</code></pre></div>

<p>The BPF program records stack traces in special <code>stack_traces</code> BPF map
which is indexed by stack IDs.
The map value is an array of memory addresses that represent the code executed.</p>
<table>
<thead>
<tr>
<th>stack ID</th>
<th>memory addresses</th>
</tr>
</thead>
<tbody>
<tr>
<td>1253</td>
<td>[ 0xdeadbeef; 0x123abcde; ... ]</td>
</tr>
<tr>
<td>0234</td>
<td>[ 0x597be95a; 0xae5ee03; ... ]</td>
</tr>
</tbody>
</table>
<p>The <code>counts</code> BPF map keeps track of how many times a stack trace has been seen:</p>
<ul>
<li>its key is a triple of PID, user-space stack ID, and kernel-space stack ID, see <code>struct stack_count_key_t { ... }</code></li>
<li>its value is the amount of times that stack trace has been observed</li>
</ul>
<table>
<thead>
<tr>
<th>stack_count_key_t</th>
<th>seen</th>
</tr>
</thead>
<tbody>
<tr>
<td>{ 10342; 1253; 0234 }</td>
<td>45</td>
</tr>
</tbody>
</table>
<p>The maps are populated using
<a href="https://elixir.bootlin.com/linux/latest/source/include/uapi/linux/bpf.h#L2080">bpf_get_stackid()</a>
and <code>bpf_map_lookup_or_try_init()</code> functions.</p>
<div class="highlight"><pre><span></span><code><span class="c1">// Create a key for &quot;counts&quot; map.</span>
<span class="k">struct</span> <span class="n">stack_count_key_t</span> <span class="n">key</span> <span class="o">=</span> <span class="p">{.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">tgid</span><span class="p">};</span>
<span class="c1">// Read user-space stack ID and insert memory addresses into stack_traces map.</span>
<span class="c1">// The positive or null stack id is returned on success,</span>
<span class="c1">// or a negative error in case of failure.</span>
<span class="n">key</span><span class="p">.</span><span class="n">user_stack_id</span> <span class="o">=</span> <span class="n">bpf_get_stackid</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stack_traces</span><span class="p">,</span> <span class="n">BPF_F_USER_STACK</span><span class="p">);</span>
<span class="c1">// Read kernel-space stack ID and insert memory addresses into stack_traces map.</span>
<span class="n">key</span><span class="p">.</span><span class="n">kernel_stack_id</span> <span class="o">=</span> <span class="n">bpf_get_stackid</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stack_traces</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">u64</span> <span class="n">zero</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">u64</span> <span class="o">*</span><span class="n">seen</span><span class="p">;</span>
<span class="n">seen</span> <span class="o">=</span> <span class="n">bpf_map_lookup_or_try_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">counts</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">zero</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">seen</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// Atomically increments the seen counter.</span>
<span class="n">__sync_fetch_and_add</span><span class="p">(</span><span class="n">seen</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</code></pre></div>

<p>On Go side the BPF maps are read every 10 seconds,
get processed, and then purged to reset for the next iteration.</p>
<h3>DIY profiler</h3>
<p>Parca Agent relies on <a href="https://github.com/aquasecurity/libbpfgo">cgo bindings for libbpf</a> from Aqua Security.
I wanted to make something similar using
<a href="https://github.com/cilium/ebpf">github.com/cilium/ebpf</a> which doesn't need cgo.</p>
<p>In order to prepare the environment I ran Ubuntu 21.10 in a virtual machine and installed Clang with Go.</p>
<div class="highlight"><pre><span></span><code><span class="go">﹪ cat &gt; Vagrantfile &lt;&lt;CFG</span>
<span class="go">Vagrant.configure(&quot;2&quot;) do |config|</span>
<span class="go">    config.vm.box = &quot;ubuntu/impish64&quot;</span>
<span class="go">end</span>
<span class="go">CFG</span>
<span class="go">﹪ vagrant up</span>
<span class="go">﹪ vagrant ssh</span>
<span class="go">﹩ sudo apt-get update</span>
<span class="go">﹩ sudo apt-get install clang</span>
<span class="go">﹩ sudo snap install go --classic</span>
<span class="go">﹩ uname -nr</span>
<span class="go">ubuntu-impish 5.13.0-39-generic</span>
<span class="go">﹩ clang -v</span>
<span class="go">Ubuntu clang version 13.0.0-2</span>
</code></pre></div>

<p>Then I copied
<a href="https://github.com/parca-dev/parca-agent/blob/31253527651ebebb74c6200eb68fe9251479ed6b/parca-agent.bpf.c">parca-agent.bpf.c</a>
from parca-agent repository and tried to generate Go files using bpf2go tool.</p>
<div class="highlight"><pre><span></span><code><span class="go">﹩ cd /vagrant/</span>
<span class="go">﹩ mkdir -p cmd/profiler/bpf/</span>
<span class="go">﹩ curl -o cmd/profiler/bpf/parca-agent.bpf.c https://raw.githubusercontent.com/parca-dev/parca-agent/31253527651ebebb74c6200eb68fe9251479ed6b/parca-agent.bpf.c</span>
<span class="go">﹩ cat &gt; cmd/profiler/main.go &lt;&lt;&lt;&#39;&#39;&#39;</span>
<span class="go">package main</span>

<span class="go">//go:generate go run github.com/cilium/ebpf/cmd/bpf2go -cflags $BPF_CFLAGS -cc clang-13 ParcaAgent ./bpf/parca-agent.bpf.c -- -I../../headers</span>

<span class="go">func main() {}</span>
<span class="go">&#39;&#39;&#39;</span>
<span class="go">﹩ go mod init diy-parca-agent</span>
<span class="go">﹩ go get github.com/cilium/ebpf/cmd/bpf2go</span>
<span class="go">﹩ go generate ./cmd/profiler/</span>
<span class="go">/vagrant/cmd/profiler/bpf/parca-agent.bpf.c:11:10: fatal error: &#39;vmlinux.h&#39; file not found</span>
</code></pre></div>

<p><code>vmlinux.h</code> can be generated from the installed kernel using bpftool tool.</p>
<div class="highlight"><pre><span></span><code><span class="go">﹩ mkdir headers</span>
<span class="go">﹩ sudo apt-get install linux-tools-$(uname -r) linux-tools-common</span>
<span class="go">﹩ bpftool btf dump file /sys/kernel/btf/vmlinux format c &gt; ./headers/vmlinux.h</span>
</code></pre></div>

<p>The remaining missing headers I copied from ubuntu-kernel, libbpf, and cilium repositories.</p>
<div class="highlight"><pre><span></span><code><span class="go">﹩ curl -o ./headers/bpf_core_read.h https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/impish/plain/tools/lib/bpf/bpf_core_read.h</span>
<span class="go">﹩ curl -o ./headers/bpf_endian.h https://raw.githubusercontent.com/cilium/ebpf/master/examples/headers/bpf_endian.h</span>
<span class="go">﹩ curl -o ./headers/bpf_helpers.h https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/impish/plain/tools/lib/bpf/bpf_helpers.h</span>
<span class="go">﹩ curl -o ./headers/bpf_tracing.h https://git.launchpad.net/~ubuntu-kernel/ubuntu/+source/linux/+git/impish/plain/tools/lib/bpf/bpf_tracing.h</span>
<span class="go">﹩ curl -o ./headers/bpf_helper_defs.h https://raw.githubusercontent.com/libbpf/libbpf/master/src/bpf_helper_defs.h</span>
</code></pre></div>

<p>Finally, all the dependencies were resolved and Go code was generated.</p>
<div class="highlight"><pre><span></span><code><span class="go">﹩ go generate ./cmd/profiler/</span>
<span class="go">Compiled /vagrant/cmd/profiler/parcaagent_bpfel.o</span>
<span class="go">Stripped /vagrant/cmd/profiler/parcaagent_bpfel.o</span>
<span class="go">Wrote /vagrant/cmd/profiler/parcaagent_bpfel.go</span>
<span class="go">Compiled /vagrant/cmd/profiler/parcaagent_bpfeb.o</span>
<span class="go">Stripped /vagrant/cmd/profiler/parcaagent_bpfeb.o</span>
<span class="go">Wrote /vagrant/cmd/profiler/parcaagent_bpfeb.go</span>
</code></pre></div>

<p>Next step was to see whether <code>DoSample</code> BPF program is loaded into the kernel from an ELF.
<code>ParcaAgentObjects{}</code> contains all objects (BPF program and BPF maps) after they have been loaded into the kernel.</p>
<div class="highlight"><pre><span></span><code><span class="nx">objs</span> <span class="o">:=</span> <span class="nx">ParcaAgentObjects</span><span class="p">{}</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">LoadParcaAgentObjects</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">objs</span><span class="p">,</span> <span class="kc">nil</span><span class="p">);</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;failed to load BPF program and maps: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
    <span class="k">return</span>
<span class="p">}</span>
<span class="k">defer</span> <span class="nx">objs</span><span class="p">.</span><span class="nx">Close</span><span class="p">()</span>
</code></pre></div>

<p>It worked, no errors were printed.</p>
<div class="highlight"><pre><span></span><code><span class="go">﹩ sudo go run ./cmd/profiler/</span>
</code></pre></div>

<blockquote>
<p>A call to perf_event_open() creates a file descriptor
that allows measuring performance information.
Each file descriptor corresponds to one event that is measured.
Events can be enabled and disabled via ioctl(2).
https://man7.org/linux/man-pages/man2/perf_event_open.2.html</p>
</blockquote>
<p>It's time to attach <code>DoSample</code> BPF program to perf event using
<code>unix.PerfEventOpen()</code> and <code>unix.IoctlSetInt()</code> functions.
Note, Parca Agent doesn't directly use <code>unix.IoctlSetInt()</code> and relies on
<a href="https://pkg.go.dev/github.com/aquasecurity/libbpfgo#BPFProg.AttachPerfEvent">AttachPerfEvent()</a>
function from <a href="http://github.com/aquasecurity/libbpfgo">github.com/aquasecurity/libbpfgo</a>.
I found cilium related explanation <a href="https://github.com/cilium/ebpf/discussions/548">#548</a>
how to achieve the same thing:</p>
<ol>
<li>Load the BPF program into the kernel: <code>LoadParcaAgentObjects(&amp;objs, nil)</code></li>
<li>Open the perf event: <code>fd, _ := unix.PerfEventOpen(...)</code>.</li>
<li>Set the BPF program on the perf event:
  <code>unix.IoctlSetInt(fd, unix.PERF_EVENT_IOC_SET_BPF, objs.DoSample.FD())</code></li>
<li>Enable the perf event:
   <code>unix.IoctlSetInt(fd, unix.PERF_EVENT_IOC_ENABLE, 0)</code></li>
</ol>
<p>Those steps worked as well.
I was hopeful to see whether stack traces were collected,
so I periodically printed the content of <code>Counts</code> BPF map.</p>
<div class="highlight"><pre><span></span><code><span class="kd">type</span> <span class="nx">stackCountKey</span> <span class="kd">struct</span> <span class="p">{</span>
    <span class="nx">PID</span>           <span class="kt">uint32</span>
    <span class="nx">UserStackID</span>   <span class="kt">int32</span>
    <span class="nx">KernelStackID</span> <span class="kt">int32</span>
<span class="p">}</span>

<span class="kd">var</span> <span class="p">(</span>
    <span class="nx">key</span>   <span class="nx">stackCountKey</span>
    <span class="nx">value</span> <span class="kt">uint64</span>
<span class="p">)</span>
<span class="nx">it</span> <span class="o">:=</span> <span class="nx">objs</span><span class="p">.</span><span class="nx">ParcaAgentMaps</span><span class="p">.</span><span class="nx">Counts</span><span class="p">.</span><span class="nx">Iterate</span><span class="p">()</span>
<span class="k">for</span> <span class="nx">it</span><span class="p">.</span><span class="nx">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="nx">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="nx">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">fmt</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;%+v seen %d times\n&quot;</span><span class="p">,</span> <span class="nx">key</span><span class="p">,</span> <span class="nx">value</span><span class="p">)</span>
<span class="p">}</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">it</span><span class="p">.</span><span class="nx">Err</span><span class="p">();</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
    <span class="nx">log</span><span class="p">.</span><span class="nx">Printf</span><span class="p">(</span><span class="s">&quot;failed to read from Counts map: %v&quot;</span><span class="p">,</span> <span class="nx">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<p>The easiest way to reliably get stack traces was to run <code>top</code> in another terminal.
I made the profiler focus on its PID 15958 and it worked 🎉.</p>
<div class="highlight"><pre><span></span><code><span class="go">﹩ top</span>
<span class="go">﹩ sudo go run ./cmd/profiler/ -pid 15958</span>
<span class="go">Waiting for stack traces...</span>
<span class="go">{PID:15958 UserStackID:132 KernelStackID:114} seen 1 times</span>
<span class="go">{PID:15958 UserStackID:709 KernelStackID:-14} seen 1 times # -14 indicates bpf_get_stackid() error.</span>
<span class="go">{PID:15958 UserStackID:366 KernelStackID:30} seen 2 times</span>
<span class="go">{PID:15958 UserStackID:674 KernelStackID:943} seen 1 times</span>
</code></pre></div>

<p>The end of my post is an disappointing anticlimax because
I haven't looked yet at how to show the actual stack traces.
I will update <a href="https://github.com/marselester/diy-parca-agent">the repository</a> when I have time.</p><p class="subheader">Category: <a href="https://marselester.com/category/go.html">Go</a>

    Tagged: 
    <a href="https://marselester.com/tag/bpf.html">bpf </a>
    <a href="https://marselester.com/tag/golang.html">golang </a>
    <a href="https://marselester.com/tag/monitoring.html">monitoring </a>
</p>



<p><a href="https://marselester.com/continuous-profiling-in-go.html#disqus_thread">comments</a></p>            </article>


                <hr  class="gradient"/>


        


            <article>
                <a href="https://marselester.com/bpf-go-program-in-kubernetes.html"><h3 class="article-title">BPF Go program in Kubernetes</h3></a>
<h6 class="subheader" title="2021-11-17T00:00:00+07:00">Wed 17 November 2021
</h6>


<p>BPF opens a lot of possibilities of making observability tools running in Kubernetes.
One can start with <a href="https://github.com/iovisor/bcc/tree/master/libbpf-tools">BCC libbpf-tools</a> written in C,
e.g., launch tcpconnlat program and process its stdout with another program to
detect cases when it took too long to establish a TCP connection.
For example, <code>curl …</code></p><p class="subheader">Category: <a href="https://marselester.com/category/go.html">Go</a>

    Tagged: 
    <a href="https://marselester.com/tag/bpf.html">bpf </a>
    <a href="https://marselester.com/tag/golang.html">golang </a>
    <a href="https://marselester.com/tag/kubernetes.html">kubernetes </a>
</p>



<p><a href="https://marselester.com/bpf-go-program-in-kubernetes.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/bpf-go-program-in-kubernetes.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/bpf-go-frontend-for-tcpconnect.html"><h3 class="article-title">BPF: Go frontend for tcpconnect</h3></a>
<h6 class="subheader" title="2021-11-01T00:00:00+07:00">Mon 01 November 2021
</h6>


<p><a href="https://marselester.com/bpf-go-frontend-for-execsnoop.html">In the previos BPF post</a>
I shared my experiment of writing Go frontend for execsnoop.
Here I would like to focus on tcpconnect, a BCC tool to trace new TCP active connections.
It is useful for determining who is connecting to whom.
This works by tracing the <code>tcp_v4_connect()</code> and <code>tcp_v6_connect …</code></p><p class="subheader">Category: <a href="https://marselester.com/category/go.html">Go</a>

    Tagged: 
    <a href="https://marselester.com/tag/bpf.html">bpf </a>
    <a href="https://marselester.com/tag/golang.html">golang </a>
</p>



<p><a href="https://marselester.com/bpf-go-frontend-for-tcpconnect.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/bpf-go-frontend-for-tcpconnect.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/bpf-go-frontend-for-execsnoop.html"><h3 class="article-title">BPF: Go frontend for execsnoop</h3></a>
<h6 class="subheader" title="2021-10-26T00:00:00+07:00">Tue 26 October 2021
</h6>


<p>After reading Brendan Gregg's books about BPF I was excited to try and implement something in Go.
At a first glance it turned out I would need to install LLVM, Clang, and kernel header dependencies to run a simple program.
Fortunately <a href="https://www.brendangregg.com/blog/2020-11-04/bpf-co-re-btf-libbpf.html">BTF, CO-RE technologies</a>
eliminate those dependencies though kernel &gt;=5 …</p><p class="subheader">Category: <a href="https://marselester.com/category/go.html">Go</a>

    Tagged: 
    <a href="https://marselester.com/tag/bpf.html">bpf </a>
    <a href="https://marselester.com/tag/golang.html">golang </a>
</p>



<p><a href="https://marselester.com/bpf-go-frontend-for-execsnoop.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/bpf-go-frontend-for-execsnoop.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/apigate-ambassador.html"><h3 class="article-title">Ambassador as API Gateway</h3></a>
<h6 class="subheader" title="2019-03-13T00:00:00+07:00">Wed 13 March 2019
</h6>


<p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/architecture/microservices/design/gateway">API gateway</a>
acts as a reverse proxy, routing API requests from clients to services.
Usually it also performs authentication and rate limiting, so the services behind the gate don't have to.
In this short tutorial we'll see how to achieve that with <a class="reference external" href="https://getambassador.io/">Ambassador</a>.</p>
<p>The demo is based on a dummy …</p><p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/ambassador.html">ambassador </a>
    <a href="https://marselester.com/tag/kubernetes.html">kubernetes </a>
    <a href="https://marselester.com/tag/api-gateway.html">api gateway </a>
    <a href="https://marselester.com/tag/auth.html">auth </a>
    <a href="https://marselester.com/tag/rate-limiting.html">rate limiting </a>
</p>



<p><a href="https://marselester.com/apigate-ambassador.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/apigate-ambassador.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/apigate-traefik.html"><h3 class="article-title">Traefik as API Gateway</h3></a>
<h6 class="subheader" title="2019-03-12T00:00:00+07:00">Tue 12 March 2019
</h6>


<p><a class="reference external" href="https://docs.microsoft.com/en-us/azure/architecture/microservices/design/gateway">API gateway</a>
acts as a reverse proxy, routing API requests from clients to services.
Usually it also performs authentication and rate limiting, so the services behind the gate don't have to.
In this short tutorial we'll see how to achieve that with <a class="reference external" href="https://traefik.io/">Traefik</a> reverse-proxy.</p>
<p>The demo is based on a …</p><p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/traefik.html">traefik </a>
    <a href="https://marselester.com/tag/kubernetes.html">kubernetes </a>
    <a href="https://marselester.com/tag/api-gateway.html">api gateway </a>
    <a href="https://marselester.com/tag/auth.html">auth </a>
    <a href="https://marselester.com/tag/rate-limiting.html">rate limiting </a>
</p>



<p><a href="https://marselester.com/apigate-traefik.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/apigate-traefik.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/how-to-structure-go-projects.html"><h3 class="article-title">How to Structure Go Projects</h3></a>
<h6 class="subheader" title="2018-09-28T00:00:00+07:00">Fri 28 September 2018
</h6>


<p>I came to Go from Django where the framework defines project layout, thus I wanted to know
how to structure my Go applications. After reading documentation and building a few Django projects,
you get a clear mental picture, as most of the questions are already answered.
That helps to keep …</p><p class="subheader">Category: <a href="https://marselester.com/category/go.html">Go</a>

    Tagged: 
    <a href="https://marselester.com/tag/golang.html">golang </a>
    <a href="https://marselester.com/tag/project-structure.html">project structure </a>
    <a href="https://marselester.com/tag/domain-driven-design.html">Domain-Driven Design </a>
</p>



<p><a href="https://marselester.com/how-to-structure-go-projects.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/how-to-structure-go-projects.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/prometheus-via-dogstatsd.html"><h3 class="article-title">Forward DogStatsD Metrics to Prometheus</h3></a>
<h6 class="subheader" title="2017-06-17T00:00:00+07:00">Sat 17 June 2017
</h6>


<p><strong>tl;dr:</strong> StatsD doesn't have metric labels, DogStatsD does.</p>
<p>This is a follow up post after
<a class="reference external" href="https://marselester.com/django-prometheus-via-statsd.html">Instrumenting Django with Prometheus and StatsD</a>.</p>
<hr class="docutils" />
<p>You got Prometheus up and running and eager to start instrumenting your Django application.
Don't be hasty and read <a class="reference external" href="https://prometheus.io/docs/practices/instrumentation/">Prometheus Best Practices</a>.</p>
<p>Let's say our application has to …</p><p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/prometheus.html">prometheus </a>
    <a href="https://marselester.com/tag/monitoring.html">monitoring </a>
    <a href="https://marselester.com/tag/statsd.html">statsd </a>
    <a href="https://marselester.com/tag/dogstatsd.html">dogstatsd </a>
    <a href="https://marselester.com/tag/datadog.html">datadog </a>
</p>



<p><a href="https://marselester.com/prometheus-via-dogstatsd.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/prometheus-via-dogstatsd.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/django-prometheus-via-statsd.html"><h3 class="article-title">Instrumenting Django with Prometheus and StatsD</h3></a>
<h6 class="subheader" title="2017-06-09T00:00:00+07:00">Fri 09 June 2017
</h6>


<p>If you ever wondered how to monitor your Django application with Prometheus this article is for you.
Quick search on the topic will lead you to <a class="reference external" href="https://github.com/korfuri/django-prometheus/">django-prometheus</a>.
For those who don't want to use it, there is another way to export application metrics
via <a class="reference external" href="https://www.datadoghq.com/blog/statsd/">StatsD</a>.</p>
<p>The idea is to send …</p><p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/prometheus.html">prometheus </a>
    <a href="https://marselester.com/tag/kubernetes.html">kubernetes </a>
    <a href="https://marselester.com/tag/monitoring.html">monitoring </a>
    <a href="https://marselester.com/tag/statsd.html">statsd </a>
    <a href="https://marselester.com/tag/helm.html">helm </a>
</p>



<p><a href="https://marselester.com/django-prometheus-via-statsd.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/django-prometheus-via-statsd.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/minukube-aws-ecr.html"><h3 class="article-title">Minukube &amp; Amazon EC2 Container Registry</h3></a>
<h6 class="subheader" title="2016-12-05T00:00:00+07:00">Mon 05 December 2016
</h6>


<p><a class="reference external" href="http://kubernetes.io/docs/getting-started-guides/minikube/">Minukube</a> is an easy way to run Kubernetes locally.
When we want to build a Docker image in Minukube (so Kubernetes has an access to it),
we can configure our Docker client to communicate with the Minikube Docker daemon.</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> minikube start
<span class="go">Starting local Kubernetes cluster...</span>
<span class="go">Kubectl is now configured to …</span></pre></div><p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/kubernetes.html">kubernetes </a>
    <a href="https://marselester.com/tag/aws.html">aws </a>
    <a href="https://marselester.com/tag/minukube.html">minukube </a>
</p>



<p><a href="https://marselester.com/minukube-aws-ecr.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/minukube-aws-ecr.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/prometheus-on-kubernetes.html"><h3 class="article-title">Prometheus on Kubernetes</h3></a>
<h6 class="subheader" title="2016-11-13T00:00:00+07:00">Sun 13 November 2016
</h6>


<p><a class="reference external" href="https://prometheus.io/">Prometheus</a> is a monitoring toolkit.
Let's set it up on Kubernetes and test how it works by scraping HTTP request metrics
from <a class="reference external" href="https://github.com/marselester/prometheus-on-kubernetes">hello web application</a>
which also runs in the same cluster.</p>
<p>First of all, we need Kubernetes cluster running. It's easy to bootstrap one via <a class="reference external" href="https://console.cloud.google.com">Google Container Engine</a>.</p>
<div class="highlight"><pre><span></span><span class="gp">$</span> gcloud …</pre></div><p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/prometheus.html">prometheus </a>
    <a href="https://marselester.com/tag/kubernetes.html">kubernetes </a>
    <a href="https://marselester.com/tag/monitoring.html">monitoring </a>
    <a href="https://marselester.com/tag/golang.html">golang </a>
    <a href="https://marselester.com/tag/google-container-engine.html">Google Container Engine </a>
</p>



<p><a href="https://marselester.com/prometheus-on-kubernetes.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/prometheus-on-kubernetes.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/drf-pagination.html"><h3 class="article-title">Django REST framework: pagination on PostgreSQL triggers</h3></a>
<h6 class="subheader" title="2016-04-02T00:00:00+07:00">Sat 02 April 2016
</h6>


<p>Django and Django REST Framework use SQL COUNT in pagination.
As your database grows SQL COUNT becomes too slow. Fortunately the frameworks
are well designed and allow to customize a way items are count.
Let me illustrate that on a typical &quot;books&quot; example.</p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Author</span><span class="p">(</span><span class="n">models</span><span class="o">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">CharField …</span></pre></div><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/postgresql.html">postgresql </a>
    <a href="https://marselester.com/tag/django-rest-framework.html">django rest framework </a>
    <a href="https://marselester.com/tag/pagination.html">pagination </a>
</p>



<p><a href="https://marselester.com/drf-pagination.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/drf-pagination.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/api-based-on-flask.html"><h3 class="article-title">API based on Flask</h3></a>
<h6 class="subheader" title="2013-12-09T00:00:00+07:00">Mon 09 December 2013
</h6>


<p>Here I want to consider implementation of API best practices which
usually don't follow Fielding's REST strictly. <a class="reference external" href="https://github.com/marselester/api-example-based-on-flask">Example Flask project</a>
is on GitHub.</p>
<div class="section" id="api-versioning">
<h2>API Versioning</h2>
<p>Interfaces are changed hence versioning is mandatory in order to not annoy
your users. You might need to add new resource or field to particular …</p></div><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/flask.html">flask </a>
    <a href="https://marselester.com/tag/api.html">api </a>
</p>



<p><a href="https://marselester.com/api-based-on-flask.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/api-based-on-flask.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/saltstack-slides.html"><h3 class="article-title">Slides about SaltStack</h3></a>
<h6 class="subheader" title="2013-12-03T00:00:00+07:00">Tue 03 December 2013
</h6>


<p><strong>Update</strong> I gave a talk with <a class="reference external" href="https://twitter.com/shr">Simon Robson</a> at <a class="reference external" href="https://twitter.com/barcampcm">Beercamp</a> in Chiang Mai,
Thailand on 12 Dec 2013. We compared Salt and <a class="reference external" href="http://slid.es/simonrobson/ansible">Ansible</a>.
Here are my <a class="reference external" href="https://slid.es/marselester/saltstack">slides</a>.</p>
<p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/salt.html">salt </a>
    <a href="https://marselester.com/tag/saltstack.html">saltstack </a>
    <a href="https://marselester.com/tag/slides.html">slides </a>
    <a href="https://marselester.com/tag/talk.html">talk </a>
</p>



<p><a href="https://marselester.com/saltstack-slides.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/saltstack-slides.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/developing-and-deploying-django-project-with-saltstack.html"><h3 class="article-title">Developing &amp; Deploying Django project with SaltStack</h3></a>
<h6 class="subheader" title="2013-11-28T00:00:00+07:00">Thu 28 November 2013
</h6>


<p>Eventually you will need to deploy project,
but deployment was not considered in the <a class="reference external" href="https://marselester.com/developing-django-project-with-saltstack.html">previous post</a>. Let's find it out.</p>
<p>Server configuration is different from local, thus environments will be needed
(at least production <strong>prod</strong> and development <strong>dev</strong>). Salt uses <strong>base</strong>
environment by default.</p>
<p>Environments are set in <tt class="docutils literal">minion.conf …</tt></p><p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/vagrant.html">vagrant </a>
    <a href="https://marselester.com/tag/salt.html">salt </a>
    <a href="https://marselester.com/tag/saltstack.html">saltstack </a>
</p>



<p><a href="https://marselester.com/developing-and-deploying-django-project-with-saltstack.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/developing-and-deploying-django-project-with-saltstack.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/developing-django-project-with-saltstack.html"><h3 class="article-title">Developing Django project with SaltStack</h3></a>
<h6 class="subheader" title="2013-11-09T00:00:00+07:00">Sat 09 November 2013
</h6>


<p>Let's use <a class="reference external" href="https://github.com/marselester/abstract-internal-messaging">Messaging System</a> as an example of Django project. I want it to
run in VirtualBox which is managed by Vagrant. Infrastructure management
is provided by SaltStack.</p>
<p>I advise you to create separate folder for repositories (currently there
is only one) of project and clone <a class="reference external" href="https://github.com/marselester/abstract-internal-messaging">Messaging System</a> there.
Also …</p><p class="subheader">Category: <a href="https://marselester.com/category/infrastructure.html">Infrastructure</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/vagrant.html">vagrant </a>
    <a href="https://marselester.com/tag/salt.html">salt </a>
    <a href="https://marselester.com/tag/saltstack.html">saltstack </a>
</p>



<p><a href="https://marselester.com/developing-django-project-with-saltstack.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/developing-django-project-with-saltstack.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/preparation-to-python-interview.html"><h3 class="article-title">Preparation to Python Interview</h3></a>
<h6 class="subheader" title="2012-11-02T00:00:00+07:00">Fri 02 November 2012
</h6>


<p>I decided to collect a little more information and experience during
preparation to Python developer interview. These are some information and
links which seemed important to me. Maybe it will be helpful.</p>
<div class="section" id="how-does-it-usually-go">
<h2>How does it usually go?</h2>
<div class="section" id="what-kind-of-projects-did-you-participate-in">
<h3>What kind of projects did you participate in?</h3>
<p>What did you do at …</p></div></div><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/interview.html">interview </a>
</p>



<p><a href="https://marselester.com/preparation-to-python-interview.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/preparation-to-python-interview.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/django-todo-testing-during-construction.html"><h3 class="article-title">Django TODO: тестирование во время конструирования</h3></a>
<h6 class="subheader" title="2012-06-29T13:00:00+07:00">Fri 29 June 2012
</h6>


<p>Тестирование, выполняемое разработчиками -- один из важнейших элементов полной
стратегии тестирования.</p>
<p>Тестирование может указать только на отдельные дефектные области программы --
оно не сделает программу удобнее в использовании, более быстрой, компактной,
удобочитаемой или расширяемой.</p>
<p>Цель тестирования противоположна целям других этапов разработки. Его целью
является нахождение ошибок. Успешным считается тест, нарушающий работу ПО …</p><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/django-todo.html">django-todo </a>
    <a href="https://marselester.com/tag/testing.html">testing </a>
</p>



<p><a href="https://marselester.com/django-todo-testing-during-construction.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/django-todo-testing-during-construction.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/django-todo-system-construction.html"><h3 class="article-title">Django TODO: конструирование системы</h3></a>
<h6 class="subheader" title="2012-06-29T12:00:00+07:00">Fri 29 June 2012
</h6>


<p>При работе над проектом конструирование включает другие процессы, в том числе
проектирование. Формальная архитектура дает ответы только на вопросы
системного уровня, при этом значительная часть проектирования может быть
намеренно оставлена на этап конструирования. Проектирование -- это
&quot;постепенный&quot; процесс. Проекты приложений не возникают в умах разработчиков
сразу в готовом виде. Они развиваются …</p><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/django-todo.html">django-todo </a>
    <a href="https://marselester.com/tag/construction.html">construction </a>
</p>



<p><a href="https://marselester.com/django-todo-system-construction.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/django-todo-system-construction.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/django-todo-design-architecture.html"><h3 class="article-title">Django TODO: проектирование архитектуры системы</h3></a>
<h6 class="subheader" title="2012-06-29T11:00:00+07:00">Fri 29 June 2012
</h6>


<p>Следующим этапом разработки системы является проектирование архитектуры.</p>
<p>Архитектура должна быть продуманным концептуальным целым. Главный тезис самой
популярной книги по разработке ПО &quot;Мифический человеко-месяц&quot; гласит, что
основной проблемой, характерной для крупных систем, является поддержание их
концептуальной целостности. Хорошая архитектура должна соответствовать
проблеме <a class="footnote-reference" href="#mcconnell" id="id1">[1]</a>.</p>
<p>Разделение системы на подсистемы на уровне архитектуры, позволяет …</p><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/django-todo.html">django-todo </a>
    <a href="https://marselester.com/tag/architecture.html">architecture </a>
</p>



<p><a href="https://marselester.com/django-todo-design-architecture.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/django-todo-design-architecture.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/django-todo-development-of-system-requirements.html"><h3 class="article-title">Django TODO: выработка требований к системе</h3></a>
<h6 class="subheader" title="2012-06-29T11:00:00+07:00">Fri 29 June 2012
</h6>


<p>После прочтения Макконелла захотелось спроецировать его советы на Django.
Для этого я взял за основу разработку системы <a class="reference external" href="https://github.com/marselester/django-todo">Django TODO</a>. Итак, первый этап -- выработка требований к
системе.</p>
<p>Требования подробно описывают, что должна делать система. Внимание к
требованиям помогает свести к минимуму изменения системы после начала
разработки. Явные требования помогают гарантировать, что …</p><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/django-todo.html">django-todo </a>
    <a href="https://marselester.com/tag/requirements.html">requirements </a>
</p>



<p><a href="https://marselester.com/django-todo-development-of-system-requirements.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/django-todo-development-of-system-requirements.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/links-to-best-practices-of-python-django.html"><h3 class="article-title">Соглашения по разработке на Python/Django</h3></a>
<h6 class="subheader" title="2012-06-29T00:00:00+07:00">Fri 29 June 2012
</h6>


<p>Во время разработки я часто сверяюсь с известными мне соглашениями,
стараюсь следовать рекомендациям. Цитировать их не имеет смысла -- лучше
приведу ссылки.</p>
<p><a class="reference external" href="http://www.python.org/dev/peps/pep-0008/">PEP 8 -- Style Guide for Python Code</a>.</p>
<p><a class="reference external" href="http://python.net/~goodger/projects/pycon/2007/idiomatic/handout.html#long-lines-continuations">Code Like a Pythonista: Idiomatic Python</a>.
В нем я нашел ответы на вопросы форматирования длинных строк:</p>
<pre class="literal-block">
expended_time = (self.finish_date() - self.start_date
                 + datetime …</pre><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/best-practices.html">best practices </a>
</p>



<p><a href="https://marselester.com/links-to-best-practices-of-python-django.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/links-to-best-practices-of-python-django.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/splitting-settings-in-django.html"><h3 class="article-title">Разделение настроек в Django</h3></a>
<h6 class="subheader" title="2012-06-29T00:00:00+07:00">Fri 29 June 2012
</h6>


<p>В <a class="reference external" href="https://code.djangoproject.com/wiki/SplitSettings">Django wiki</a> собраны
различные способы разделения настроек. Мне нравится <a class="reference external" href="http://senko.net/en/django-quickstart-skeleton-project/">вариант</a>, описанный в блоге
Senko Rašić:</p>
<pre class="literal-block">
settings/
├── __init__.py
├── base.py
├── development.py
├── local.py
└── production.py
</pre>
<p><tt class="docutils literal">base.py</tt> содержит общие настройки для <tt class="docutils literal">development.py</tt> и
<tt class="docutils literal">production.py</tt>, например:</p>
<div class="highlight"><pre><span></span><span class="n">ADMINS</span> <span class="o">=</span> <span class="p">()</span>
<span class="n">MANAGERS</span> <span class="o">=</span> <span class="n">ADMINS</span>

<span class="n">TIME_ZONE</span> <span class="o">=</span> <span class="s1">&#39;Asia/Yekaterinburg&#39;</span>
<span class="c1"># ...</span>
</pre></div>
<p><tt class="docutils literal">production.py</tt> содержит настройки для …</p><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/settings.html">settings </a>
</p>



<p><a href="https://marselester.com/splitting-settings-in-django.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/splitting-settings-in-django.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/short-overview-of-infrastructure-for-developing-reusable-django-apps.html"><h3 class="article-title">Краткий обзор инфраструктуры для разработки reusable Django приложений</h3></a>
<h6 class="subheader" title="2012-06-13T00:00:00+07:00">Wed 13 June 2012
</h6>


<p>Начиная впервые разрабатывать веб-приложения на новом фреймворке программист
зачастую сталкивается с некоторыми трудностями. При разработке отчуждаемых
веб-приложений на Django к этим проблемам необходимо отнести организацию
файлов в проекте, обнаружение тестов, вопросы пакетирования приложений и
организации автоматизированного тестирования. В данной статье приведены пути
решения этих проблем.</p>
<p>Важно знать различия между двумя …</p><p class="subheader">Category: <a href="https://marselester.com/category/python.html">Python</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/django.html">django </a>
    <a href="https://marselester.com/tag/infrastructure.html">infrastructure </a>
</p>



<p><a href="https://marselester.com/short-overview-of-infrastructure-for-developing-reusable-django-apps.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/short-overview-of-infrastructure-for-developing-reusable-django-apps.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/computing-methods-of-one-dimensional-optimization.html"><h3 class="article-title">Вычислительные методы одномерной оптимизации</h3></a>
<h6 class="subheader" title="2010-10-06T00:00:00+07:00">Wed 06 October 2010
</h6>


<p>На третьем курсе по предмету методы оптимизации делали лабораторную работу на
тему «Вычислительные методы одномерной оптимизации».
Задача заключалась в поиске безусловного минимума функции
<tt class="docutils literal">f(x) = pow(x, 3) – x + pow(e, <span class="pre">-x)</span></tt> на начальном интервале <tt class="docutils literal">[0, 1]</tt>
с точностью <tt class="docutils literal">0.00001</tt>.</p>
<p>Вычисления производились через:</p>
<ul class="simple">
<li>пассивный метод;</li>
<li>равномерные блочные методы;</li>
<li>метод …</li></ul><p class="subheader">Category: <a href="https://marselester.com/category/misc.html">Misc</a>

    Tagged: 
    <a href="https://marselester.com/tag/php.html">php </a>
    <a href="https://marselester.com/tag/mathematical-optimization.html">mathematical optimization </a>
</p>



<p><a href="https://marselester.com/computing-methods-of-one-dimensional-optimization.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/computing-methods-of-one-dimensional-optimization.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/definition-of-pressing-of-a-combination-of-keys-by-means-BIOS-on-the-assembler.html"><h3 class="article-title">Определение нажатия комбинации клавиш средствами BIOS на ассемблере</h3></a>
<h6 class="subheader" title="2009-12-03T00:00:00+07:00">Thu 03 December 2009
</h6>


<p>По учебе понадобилось написать программу на ассемблере, которая должна
распознать нажатие «горячей» комбинации клавиш <tt class="docutils literal">LeftCtrl+RightShift+F3</tt> и
реагировать на него звуковым сигналом. Информации/примеров по этой теме
маловато, по этому решил опубликовать свою программку.</p>
<div class="highlight"><pre><span></span><span class="nf">masm</span>
<span class="nf">.model</span> <span class="nv">small</span>
<span class="nf">.stack</span> <span class="mi">256</span>
<span class="nf">.data</span>
    <span class="nf">Msg_about</span> <span class="nv">db</span> <span class="s">&#39;Распознать нажатие «горячей» комбинации клавиш&#39;</span><span class="p">,</span> <span class="mh">0Ah</span><span class="p">,</span> <span class="mh">0Dh …</span></pre></div><p class="subheader">Category: <a href="https://marselester.com/category/misc.html">Misc</a>

    Tagged: 
    <a href="https://marselester.com/tag/assembler.html">assembler </a>
</p>



<p><a href="https://marselester.com/definition-of-pressing-of-a-combination-of-keys-by-means-BIOS-on-the-assembler.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/definition-of-pressing-of-a-combination-of-keys-by-means-BIOS-on-the-assembler.html">Read More</a>
                <hr  class="gradient"/>
            </article>

        


            <article>
                <a href="https://marselester.com/modeling-single-channel-queue-with-refusals.html"><h3 class="article-title">Моделирование одноканальной СМО с отказами</h3></a>
<h6 class="subheader" title="2009-05-30T00:00:00+07:00">Sat 30 May 2009
</h6>


<p>Дана одноканальная система массового обслуживания с отказами. В нее поступают
заявки через промежуток времени <tt class="docutils literal">n</tt>, где <tt class="docutils literal">n</tt> – случайная величина,
подчиненная равномерному закону распределения. Время обслуживания заявки
системой <tt class="docutils literal">m</tt> также является случайной величиной с показательным законом
распределения. Если к моменту прихода заявки канал занят, заявка покидает
систему необслуженной.</p>
<p>Изначально код был …</p><p class="subheader">Category: <a href="https://marselester.com/category/misc.html">Misc</a>

    Tagged: 
    <a href="https://marselester.com/tag/python.html">python </a>
    <a href="https://marselester.com/tag/modeling.html">modeling </a>
    <a href="https://marselester.com/tag/single-channel-queue.html">single-channel queue </a>
</p>



<p><a href="https://marselester.com/modeling-single-channel-queue-with-refusals.html#disqus_thread">comments</a></p>                <a class="button radius secondary small right" href="https://marselester.com/modeling-single-channel-queue-with-refusals.html">Read More</a>
                <hr  class="gradient"/>
            </article>

            <!-- /#posts-list -->

    </div>
    <!-- End Main Content -->

    <!-- Sidebar -->
    <aside class="large-3 columns">
        <h5 class="sidebar-title">Site</h5>
        <ul class="side-nav">
            <li><a href="https://marselester.com/archives.html">Archives</a>
            <li><a href="https://marselester.com/tags.html">Tags</a>


                <li><a href="https://marselester.com/feeds/all.atom.xml" rel="alternate">Atom feed</a></li>
        </ul>

		
        <h5 class="sidebar-title">Categories</h5>
        <ul class="side-nav">
            <li><a href="https://marselester.com/category/go.html">Go</a></li>
            <li><a href="https://marselester.com/category/infrastructure.html">Infrastructure</a></li>
            <li><a href="https://marselester.com/category/misc.html">Misc</a></li>
            <li><a href="https://marselester.com/category/python.html">Python</a></li>
   
        </ul>

		
        <h5 class="sidebar-title">Social</h5>
        <ul class="side-nav">
            <li><a href="https://github.com/marselester">GitHub</a></li>
            <li><a href="https://marselester.com/instagram/index.html">Instagram 📷</a></li>
            <li><a href="http://twitter.com/marselester">Twitter</a></li>
            <li><a href="https://medium.com/@marselester/">Medium</a></li>
        </ul>

    </aside> <!-- End Sidebar -->

</div> <!-- End Main Content and Sidebar -->


<!-- Footer -->
<footer class="row">
    <div class="large-12 columns">
        <hr />
        <div class="row">
            <div class="large-6 columns">
                <p>marselester's blog by Marsel Mavletkulov</p>
            </div>
            </div>
    </div>
</footer>